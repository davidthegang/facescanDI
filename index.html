<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ប្រព័ន្ធស្កេនមុខឌីជីថល</title>
  <link rel="icon" href="https://img.freepik.com/premium-vector/face-scan-icon_933463-79729.jpg" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Moul&display=swap');
    body{font-family:'Kantumruy Pro',sans-serif;background:#0f172a;color:#e2e8f0;overflow-y:auto;overflow-x:hidden}
    .main-content{background:rgba(30,41,59,.7);border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
    #sidebar{transition:transform .3s ease-in-out} #sidebar.is-open{transform:translateX(0)}
    .nav-link.active{background:#4f46e5;color:#fff;box-shadow:0 4px 14px rgba(79,70,229,.39)}
    .video-container video{position:absolute;top:50%;left:50%;width:100%;height:100%;object-fit:cover;transform:translate(-50%,-50%) scaleX(-1)}
    .video-container{position:relative;border-radius:50%;overflow:hidden;border:5px solid transparent;transition:all .4s ease;box-shadow:0 0 15px rgba(0,0,0,.5)}
    .video-container.ready{border-color:#4ade80;box-shadow:0 0 25px rgba(74,222,128,.6)}
    .video-container.fail{border-color:#f43f5e;box-shadow:0 0 25px rgba(244,63,94,.6)}
    .scanner-line{position:absolute;left:0;width:100%;height:3px;background:linear-gradient(to right,transparent,#4ade80,transparent);box-shadow:0 0 10px #4ade80;animation:scan 3s linear infinite;opacity:0;transition:opacity .3s}
    .video-container.ready .scanner-line{opacity:1}
    @keyframes scan{0%{top:0%}50%{top:100%}100%{top:0%}}
    .modal{background:rgba(15,23,42,.8);backdrop-filter:blur(5px)} .modal-content{background:#1e293b;border:1px solid #475569}
    .khmer-title{font-family:"Moul",serif}
    .table-container{height:calc(100vh - 280px);overflow-y:auto}
    #student-list{max-height:40vh;overflow-y:auto} #student-list li:hover{background:#334155}
    #student-list li.completed{color:#4ade80!important;font-weight:600;opacity:.7;pointer-events:none}
    .filter-select{background:#E5E7EB;color:#111827;padding:.5rem 2rem .5rem .75rem;font-size:.875rem;border-radius:.5rem;border:1px solid #9CA3AF;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");background-position:right .5rem center;background-repeat:no-repeat;background-size:1.5em 1.5em}
    .filter-select option{background:#F3F4F6;color:#000}
    @media(min-width:768px){.filter-select{padding:.6rem 2.5rem .6rem 1rem;font-size:1rem}}
    ::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:#1e293b}::-webkit-scrollbar-thumb{background:#475569;border-radius:4px}
    #login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem}
    .login-card{width:100%;max-width:400px;background:rgba(30,41,59,.7);border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:1.5rem;padding:2rem;box-shadow:0 20px 50px rgba(0,0,0,.3)}
    #admin-select{background:#334155;color:#e2e8f0;border:1px solid #475569}
  </style>
</head>
<body class="bg-slate-900 text-slate-200">

  <!-- LOGIN -->
  <div id="login-screen">
    <div class="login-card text-center">
      <img src="di_logo.png" alt="Logo" class="w-24 h-24 rounded-full mx-auto mb-4 shadow-lg">
      <h1 id="login-title" class="text-2xl font-bold text-white khmer-title mb-2">Admin Login</h1>
      <p id="login-subtitle" class="text-slate-400 mb-6">សូមជ្រើសរើសឈ្មោះរបស់អ្នក</p>
      <div id="admin-selection-area">
        <div class="w-16 h-16 border-4 border-slate-500 border-t-indigo-500 rounded-full animate-spin mx-auto mb-4" id="admin-list-loader"></div>
        <select id="admin-select" class="hidden filter-select w-full text-base mb-4 py-3 px-4" style="background-position:right 1rem center;">
          <option value="">-- Select Your Name --</option>
        </select>
        <button id="proceed-to-scan-btn" class="hidden w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 transition shadow-lg">បន្តទៅការស្កេន</button>
      </div>
      <div id="admin-scan-area" class="hidden flex flex-col items-center space-y-4">
        <div id="admin-video-wrapper" class="video-container w-[90%] mx-auto aspect-square"><video id="admin-video" autoplay muted playsinline></video></div>
        <p id="admin-scan-status" class="text-center text-sm h-10 font-semibold text-slate-400"></p>
        <div class="flex flex-col w-full space-y-3">
          <button id="admin-manual-scan-btn" class="w-full bg-slate-600 text-white py-3 rounded-xl font-semibold hover:bg-slate-700 transition"><i class="fas fa-camera mr-2"></i> ស្កេនដោយខ្លួនឯង</button>
          <button id="admin-back-btn" class="w-full text-slate-400 py-2 rounded-xl font-semibold hover:text-white transition"><i class="fas fa-arrow-left mr-2"></i> ត្រលប់​ក្រោយ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="main-app-wrapper" class="hidden">
    <div class="relative min-h-screen md:flex">
      <div id="sidebar-backdrop" class="hidden md:hidden fixed inset-0 bg-black/50 z-30"></div>

      <!-- SIDEBAR -->
      <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-slate-800/80 backdrop-blur-lg z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
        <div class="text-center py-6 mb-4">
          <img src="di_logo.png" alt="Logo" class="w-20 h-20 rounded-full mx-auto mb-2 shadow-lg">
          <h2 class="text-xl font-bold text-white khmer-title">ឧស្សាហកម្មឌីជីថល</h2>
        </div>

        <ul id="sidebar-links" class="flex-1 flex flex-col space-y-2 px-4 overflow-y-auto">
          <li><a href="#" id="nav-scan" class="nav-link active flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white"><i class="fas fa-camera-retro fa-fw"></i><span class="font-semibold">ថតរូប</span></a></li>
          <li><a href="#" id="nav-list" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white"><i class="fas fa-users fa-fw"></i><span class="font-semibold">ទិន្នន័យរូបភាពនិស្សិត</span></a></li>
          <li><a href="#" id="nav-records" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white"><i class="fas fa-database fa-fw"></i><span class="font-semibold">រូបភាពបានរក្សាទុក</span></a></li>
          <li><a href="#" id="nav-storage" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white"><i class="fas fa-link fa-fw"></i><span class="font-semibold">Storage Links</span></a></li>
          <li><a href="#" id="nav-profile" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white"><i class="fas fa-id-badge fa-fw"></i><span class="font-semibold">Profile</span></a></li>
          <!-- Admin Management (superadmin only) inserted dynamically -->
        </ul>

        <div id="admin-profile-sidebar" class="p-4 border-t border-slate-700/50">
          <div class="flex items-center gap-3">
            <img id="admin-profile-img-sidebar" class="w-10 h-10 rounded-full" src="" alt="Admin" crossorigin="anonymous">
            <div>
              <p id="admin-name-sidebar" class="font-semibold text-white">Admin Name</p>
              <span id="admin-role-badge" class="text-xs px-2 py-0.5 rounded bg-slate-600">role</span>
            </div>
          </div>
          <a href="#" id="logout-btn" class="block mt-3 text-sm text-red-400 hover:text-red-300">Logout</a>
        </div>

        <footer class="p-4 border-t border-slate-700/50 text-slate-400 text-sm">
          <div class="flex flex-col items-center sm:flex-row sm:justify-between gap-2">
            <p class="text-center sm:text-left">&copy; 2025 IT Support</p>
          </div>
        </footer>
      </aside>

      <!-- CONTENT -->
      <div id="content-wrapper" class="flex flex-col flex-1 md:ml-64 transition-all duration-300 ease-in-out">
        <header class="w-full h-16 bg-slate-800/50 backdrop-blur-lg flex-shrink-0 flex items-center px-6 sticky top-0 z-20">
          <button id="menu-btn" class="text-white mr-4"><i class="fas fa-bars text-xl"></i></button>
          <h1 class="text-xl font-bold text-white khmer-title">គ្រប់គ្រងទិន្នន័យរូបភាព</h1>
          <img id="admin-profile-img-header" class="w-10 h-10 rounded-full ml-auto hidden" src="" alt="Admin" crossorigin="anonymous">
        </header>

        <main class="w-full flex-1 p-4 md:p-8">
          <!-- PAGE: SCAN -->
          <div id="page-scan">
            <div class="main-content rounded-2xl p-6">
              <div class="container w-full max-w-md mx-auto relative">
                <button id="back-btn" class="hidden absolute -top-2 -left-2 w-10 h-10 bg-slate-700/50 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-slate-600/50 transition z-20" title="Back to Selection"><i class="fas fa-arrow-left"></i></button>
                <h1 class="text-center text-2xl mb-2 text-white khmer-title">ប្រព័ន្ធស្កេនមុខឌីជីថល</h1>
                <p id="subtitle" class="text-center text-slate-400 mb-6">សូមជ្រើសរើសអត្តលេខរបស់អ្នក</p>

                <div id="selection-area" class="mb-5">
                  <input type="text" id="student-search-input" placeholder="ស្វែងរកអត្តលេខ ឬឈ្មោះ..." class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
                  <ul id="student-list" class="space-y-1"><li class="text-center text-slate-400 p-4">Loading students...</li></ul>
                </div>

                <div id="camera-section" class="hidden flex flex-col items-center space-y-4">
                  <div id="video-wrapper" class="video-container w-[90%] mx-auto aspect-square">
                    <video id="video" autoplay muted playsinline></video>
                    <div class="scanner-line"></div>
                  </div>
                  <div class="flex items-center justify-center gap-4">
                    <button id="switch-camera-btn" class="w-14 h-14 bg-slate-700/50 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-slate-600/50 transition" title="Switch Camera"><i class="fas fa-sync-alt fa-lg"></i></button>
                    <button id="manual-capture-btn" class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center text-white hover:bg-indigo-700 transition shadow-lg" title="Capture Photo"><i class="fas fa-camera fa-2x"></i></button>
                  </div>
                  <canvas id="capture-canvas" class="hidden"></canvas>
                  <img id="photo-preview" class="hidden w-[90%] mx-auto aspect-square rounded-full border-4 border-green-400 object-cover shadow-lg">
                  <p id="face-status" class="text-center text-sm h-5 font-semibold text-slate-400"></p>
                  <div class="flex flex-col w-full space-y-3">
                    <button id="upload-btn" class="hidden w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-semibold hover:opacity-90 transition shadow-lg">បញ្ជូនរូបភាព</button>
                    <button id="retake-btn" class="hidden w-full bg-slate-600 text-white py-3 rounded-xl font-semibold hover:bg-slate-700 transition">ថតម្តងទៀត</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- PAGE: LIST -->
          <div id="page-list" class="hidden main-content rounded-2xl p-6 h-full flex flex-col">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
              <h1 class="text-2xl text-white khmer-title">ទិន្នន័យរូបភាពនិស្សិត</h1>
              <div class="flex gap-4 w-full md:w-auto">
                <input type="text" id="list-search-input" placeholder="ស្វែងរកអត្តលេខឬឈ្មោះ..." class="w-full bg-slate-700 border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <select id="list-class-filter" class="filter-select w-full md:w-auto"></select>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-left">
              <div class="bg-slate-700/50 p-4 rounded-lg flex items-center gap-4"><i class="fas fa-users fa-2x text-slate-400"></i><div><p class="text-slate-400">ចំនួននិស្សិតសរុប</p><p id="list-total-count" class="text-2xl font-bold text-white">-</p></div></div>
              <div class="bg-green-800/30 p-4 rounded-lg flex items-center gap-4"><i class="fas fa-user-check fa-2x text-green-400"></i><div><p class="text-green-400">និស្សិតមានរូបភាព</p><p id="list-completed-count" class="text-2xl font-bold text-green-400">-</p></div></div>
              <div class="bg-red-800/30 p-4 rounded-lg flex items-center gap-4"><i class="fas fa-user-clock fa-2x text-red-400"></i><div><p class="text-red-400">និស្សិតគ្មានរូបភាព</p><p id="list-pending-count" class="text-2xl font-bold text-red-400">-</p></div></div>
            </div>
            <div id="list-container" class="table-container flex-1 overflow-x-auto">
              <div id="list-loading" class="text-center py-10"><p class="text-slate-400">កំពុងទាញទិន្នន័យរូបភាពនិស្សិត...</p></div>
              <table id="list-table" class="hidden w-full text-left text-slate-300">
                <thead class="bg-slate-700/50 sticky top-0"><tr><th class="p-3">ID</th><th class="p-3">ឈ្មោះ</th><th class="p-3">រូបភាព</th><th class="p-3 text-center">Status</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- PAGE: RECORDS -->
          <div id="page-records" class="hidden main-content rounded-2xl p-6 h-full flex flex-col">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
              <h1 class="text-2xl text-white khmer-title">រូបភាពបានរក្សាទុក</h1>
              <div class="flex gap-4 w-full md:w-auto">
                <input type="text" id="records-search-input" placeholder="Search ID or Name..." class="w-full bg-slate-700 border-slate-600 rounded-lg px-4 py-2">
                <select id="records-class-filter" class="filter-select w-full md:w-auto"></select>
              </div>
            </div>
            <div id="records-container" class="table-container flex-1 overflow-x-auto">
              <div id="records-loading" class="text-center py-10"><p class="text-slate-400">កំពុងទាញរូបភាពបានរក្សាទុក...</p></div>
              <table id="records-table" class="hidden w-full text-left text-slate-300">
                <thead class="bg-slate-700/50 sticky top-0"><tr><th class="p-3">ល.រ</th><th class="p-3">ឈ្មោះ</th><th class="p-3">ID</th><th class="p-3">ថ្នាក់</th><th class="p-3">ក្រុម</th><th class="p-3">រូបភាព</th><th class="p-3 text-center">កែ</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- PAGE: STORAGE -->
          <div id="page-storage" class="hidden main-content rounded-2xl p-6 h-full flex flex-col">
            <h1 class="text-2xl text-white khmer-title mb-6">Storage & Links</h1>
            <p class="text-slate-400 mb-6">Direct links to Sheets and Folders.</p>
            <div id="storage-links-container" class="space-y-6"></div>
          </div>

          <!-- PAGE: PROFILE -->
          <div id="page-profile" class="hidden main-content rounded-2xl p-6">
            <div class="max-w-2xl mx-auto">
              <div class="bg-slate-800/60 rounded-2xl p-6 md:p-8 shadow-xl border border-slate-700/50">
                <div class="flex items-center gap-6">
                  <img id="profile-photo" class="w-24 h-24 rounded-full border-4 border-indigo-500/50 shadow" src="" alt="avatar" crossorigin="anonymous">
                  <div>
                    <h2 id="profile-name" class="text-2xl font-bold">Admin Name</h2>
                    <div class="mt-1 flex items-center gap-2">
                      <span id="profile-role" class="text-xs uppercase tracking-wider px-2 py-1 rounded bg-indigo-600">ROLE</span>
                      <span class="text-slate-400">•</span>
                      <span class="text-slate-300">Position:</span>
                      <input id="profile-position" class="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm ml-1 w-40" placeholder="e.g. Head of Dept">
                      <button id="save-position" class="ml-2 text-xs px-2 py-1 bg-green-600 rounded hover:bg-green-700">Save</button>
                    </div>
                  </div>
                </div>

                <div class="mt-6">
                  <h3 class="font-semibold text-slate-200 mb-2">Permissions</h3>
                  <ul id="perm-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-slate-300 text-sm"></ul>
                </div>

                <div class="mt-6 flex gap-3">
                  <button id="logout-btn-profile" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg"><i class="fa fa-right-from-bracket mr-2"></i> Logout</button>
                </div>
              </div>
            </div>
          </div>

          <!-- PAGE: ADMIN MANAGEMENT (SUPERADMIN) -->
          <div id="page-admins" class="hidden main-content rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h1 class="text-2xl text-white khmer-title">Admin Management</h1>
              <button id="add-admin-btn" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded text-white"><i class="fa fa-plus mr-2"></i>Add Admin</button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-left text-slate-300">
                <thead class="bg-slate-700/50 sticky top-0"><tr><th class="p-3">Name</th><th class="p-3">Image</th><th class="p-3">Role</th><th class="p-3 text-center">Actions</th></tr></thead>
                <tbody id="admins-tbody"></tbody>
              </table>
            </div>
          </div>

        </main>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal">
    <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-2xl text-center">
      <div id="modal-icon" class="w-16 h-16 mx-auto mb-4"></div>
      <p id="modal-message" class="text-lg font-semibold text-white mb-6"></p>
      <div id="modal-buttons" class="flex flex-col sm:flex-row gap-4"></div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyPBipQMaJ9d8UQg2BdVXPw6ycZHb4hxcNfiJEW4LFZvceXo62UjkDCZEP7JwqJw_4u/exec';

    // ---- DOM refs & state (same as previous answer; omitted comments for brevity)
    const video = document.getElementById('video'), captureCanvas = document.getElementById('capture-canvas'),
          photoPreview = document.getElementById('photo-preview'), uploadBtn = document.getElementById('upload-btn'),
          retakeBtn = document.getElementById('retake-btn'), cameraSection = document.getElementById('camera-section'),
          videoWrapper = document.getElementById('video-wrapper'), faceStatus = document.getElementById('face-status'),
          subtitle = document.getElementById('subtitle'), switchCameraBtn = document.getElementById('switch-camera-btn'),
          backBtn = document.getElementById('back-btn'), manualCaptureBtn = document.getElementById('manual-capture-btn');

    const pageScan = document.getElementById('page-scan'), pageRecords = document.getElementById('page-records'),
          pageList = document.getElementById('page-list'), pageStorage = document.getElementById('page-storage'),
          pageProfile = document.getElementById('page-profile'), pageAdmins = document.getElementById('page-admins');
    const navScan = document.getElementById('nav-scan'), navRecords = document.getElementById('nav-records'),
          navList = document.getElementById('nav-list'), navStorage = document.getElementById('nav-storage'),
          navProfile = document.getElementById('nav-profile');
    const sidebar = document.getElementById('sidebar'), menuBtn = document.getElementById('menu-btn'),
          sidebarBackdrop = document.getElementById('sidebar-backdrop'), sidebarLinks = document.getElementById('sidebar-links');

    const adminProfileImgHeader = document.getElementById('admin-profile-img-header'),
          adminProfileSidebar = document.getElementById('admin-profile-sidebar'),
          adminProfileImgSidebar = document.getElementById('admin-profile-img-sidebar'),
          adminNameSidebar = document.getElementById('admin-name-sidebar'),
          adminRoleBadge = document.getElementById('admin-role-badge');

    const logoutBtn = document.getElementById('logout-btn'),
          logoutBtnProfile = document.getElementById('logout-btn-profile');

    const profilePhoto = document.getElementById('profile-photo'),
          profileName = document.getElementById('profile-name'),
          profileRole = document.getElementById('profile-role'),
          profilePosition = document.getElementById('profile-position'),
          savePositionBtn = document.getElementById('save-position'),
          permList = document.getElementById('perm-list');

    const selectionArea = document.getElementById('selection-area'), studentSearchInput = document.getElementById('student-search-input'),
          studentList = document.getElementById('student-list');

    const recordsLoading = document.getElementById('records-loading'), recordsTable = document.getElementById('records-table'),
          recordsClassFilter = document.getElementById('records-class-filter'), recordsSearchInput = document.getElementById('records-search-input');

    const listLoading = document.getElementById('list-loading'), listTable = document.getElementById('list-table'),
          listClassFilter = document.getElementById('list-class-filter'), listSearchInput = document.getElementById('list-search-input'),
          listTotalCount = document.getElementById('list-total-count'), listCompletedCount = document.getElementById('list-completed-count'),
          listPendingCount = document.getElementById('list-pending-count');

    const adminsTbody = document.getElementById('admins-tbody'),
          addAdminBtn = document.getElementById('add-admin-btn');

    const modal = document.getElementById('modal'), modalIcon = document.getElementById('modal-icon'),
          modalMessage = document.getElementById('modal-message'), modalButtons = document.getElementById('modal-buttons');

    const icons = {
      success:`<svg class="w-full h-full text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
      error:`<svg class="w-full h-full text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
      loading:`<div class="w-16 h-16 border-4 border-slate-500 border-t-indigo-500 rounded-full animate-spin"></div>`,
      confirm:`<svg class="w-full h-full text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`,
      choice:`<svg class="w-full h-full text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m4 13-4-4M3 10h12M3 15h4M4 19h16a1 1 0 0 0 1-1z"/></svg>`
    };

    let studentsData=[], savedRecordsData=[], allStudentsListData=[], adminData=[],
        currentStream, faceApiInterval, stableFrames=0, currentFacingMode='user',
        selectedStudent=null, currentCameraMode='auto',
        loggedInAdmin=null, adminFaceMatcher=null, adminScanInterval=null, isScanning=false,
        isUploading=false;

    // --- Session helpers
    const SESSION_KEY='di_admin_session_v1';
    const POS_KEY_PREFIX='di_admin_position_';
    function saveSession(o){ try{ localStorage.setItem(SESSION_KEY, JSON.stringify(o)); }catch(_){} }
    function loadSession(){ try{ const r=localStorage.getItem(SESSION_KEY); return r?JSON.parse(r):null; }catch(_){return null} }
    function clearSession(){ try{ localStorage.removeItem(SESSION_KEY);}catch(_){} }
    function loadPosition(name){ try{ return localStorage.getItem(POS_KEY_PREFIX+name)||''; }catch(_){return ''} }
    function savePosition(name,val){ try{ localStorage.setItem(POS_KEY_PREFIX+name, val||''); }catch(_){} }

    // --- Modal
    function showModal(type,msg,actions={}){ modalIcon.innerHTML=icons[type]; modalMessage.textContent=msg; modal.classList.remove('hidden'); modalButtons.innerHTML=''; if(type==='loading')return;
      if(Object.keys(actions).length){ for(const [t,a] of Object.entries(actions)){ const b=document.createElement('button'); b.className=a.className||"w-full bg-slate-600 text-white py-2 rounded-lg font-semibold hover:bg-slate-700 transition"; b.textContent=t; b.onclick=()=>{modal.classList.add('hidden'); a.callback&&a.callback();}; modalButtons.appendChild(b);} }
      else { const b=document.createElement('button'); b.className="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition"; b.textContent="យល់ព្រម"; b.onclick=()=>modal.classList.add('hidden'); modalButtons.appendChild(b); }
    }

    // --- FaceAPI
    async function loadModels(){ const URL='./models'; await Promise.all([ faceapi.nets.tinyFaceDetector.loadFromUri(URL), faceapi.nets.faceLandmark68Net.loadFromUri(URL), faceapi.nets.faceRecognitionNet.loadFromUri(URL), faceapi.nets.faceExpressionNet.loadFromUri(URL) ]); }

    // --- Admins fetch
    async function fetchAdmins(){
      const r = await fetch(`${SCRIPT_URL}?action=getAdmins`);
      if(!r.ok) throw new Error(`Server error: ${r.status}`);
      const j = await r.json();
      if(j.status==='error') throw new Error(j.message);
      adminData = j.data || [];
      // Fill select for login
      const adminSelect = document.getElementById('admin-select'), adminListLoader=document.getElementById('admin-list-loader');
      adminSelect.innerHTML = '<option value="">-- សូមជ្រើសរើសឈ្មោះ --</option>';
      adminData.forEach((a,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=`${a.name} (${a.role})`; adminSelect.appendChild(opt); });
      adminListLoader.classList.add('hidden'); adminSelect.classList.remove('hidden');
    }

    // --- Login selection
    const adminSelect = document.getElementById('admin-select'),
          proceedToScanBtn = document.getElementById('proceed-to-scan-btn'),
          adminSelectionArea = document.getElementById('admin-selection-area'),
          adminScanArea = document.getElementById('admin-scan-area'),
          adminVideoWrapper=document.getElementById('admin-video-wrapper'),
          adminVideo=document.getElementById('admin-video'),
          adminScanStatus=document.getElementById('admin-scan-status'),
          adminManualScanBtn=document.getElementById('admin-manual-scan-btn'),
          adminBackBtn=document.getElementById('admin-back-btn');
    adminSelect.onchange=()=>{ proceedToScanBtn.classList.toggle('hidden', !adminSelect.value); };
    proceedToScanBtn.onclick=()=>{ const i=+adminSelect.value; if(Number.isNaN(i)) return; loggedInAdmin = adminData[i]; adminSelectionArea.classList.add('hidden'); adminScanArea.classList.remove('hidden'); adminScanStatus.textContent='Starting camera...'; startAdminLoginScan(); };
    adminBackBtn.onclick=resetToAdminSelection;

    async function startAdminLoginScan(){
      adminScanStatus.textContent = `Loading reference for ${loggedInAdmin.name}...`;
      adminFaceMatcher = await createFaceMatcher(loggedInAdmin.imageUrl);
      if(!adminFaceMatcher){ adminScanStatus.textContent='Could not load reference image.'; adminVideoWrapper.classList.add('fail'); return; }
      try{
        const stream=await navigator.mediaDevices.getUserMedia({ video:{facingMode:'user',width:640,height:480} });
        currentStream=stream; adminVideo.srcObject=stream;
        adminVideo.onloadedmetadata=()=>{ adminScanStatus.textContent='Look at the camera. Auto-scanning...'; adminVideoWrapper.classList.add('ready'); startAdminScanInterval(); };
      }catch{ showModal('error','Please allow camera access.'); resetToAdminSelection(); }
    }
    async function createFaceMatcher(url){
      try{
        const img=await faceapi.fetchImage(url);
        const det=await faceapi.detectSingleFace(img,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        if(!det) return null;
        return new faceapi.FaceMatcher(new faceapi.LabeledFaceDescriptors(loggedInAdmin.name,[det.descriptor]),0.5);
      }catch(e){ console.error(e); return null; }
    }
    function startAdminScanInterval(){ clearInterval(adminScanInterval); isScanning=true; adminScanInterval=setInterval(async()=>{ if(!isScanning) return; const ok=await performAdminScan(); if(ok) onLoginSuccess(); }, 1000); }
    async function performAdminScan(){
      if(!adminFaceMatcher) return false;
      const det=await faceapi.detectSingleFace(adminVideo,new faceapi.TinyFaceDetectorOptions({inputSize:224,scoreThreshold:.5})).withFaceLandmarks().withFaceDescriptor();
      if(det){ const best=adminFaceMatcher.findBestMatch(det.descriptor); if(best.label!=='unknown'&&best.distance<0.5){ adminScanStatus.textContent=`Welcome, ${best.label}!`; adminVideoWrapper.classList.add('ready'); return true; } adminScanStatus.textContent='Face not match. Trying...'; adminVideoWrapper.classList.add('fail'); return false;}
      adminScanStatus.textContent='No face detected. Center your face.'; adminVideoWrapper.classList.remove('fail'); return false;
    }
    adminManualScanBtn.onclick=async()=>{ if(isScanning) clearInterval(adminScanInterval); isScanning=false; const ok=await performAdminScan(); if(ok) onLoginSuccess(); else { adminScanStatus.textContent='Manual scan failed. Resuming...'; setTimeout(()=>{ if(!isScanning) startAdminScanInterval(); }, 1500); } };
    function resetToAdminSelection(){ stopCamera(); adminScanArea.classList.add('hidden'); adminSelectionArea.classList.remove('hidden'); adminVideoWrapper.classList.remove('ready','fail'); adminSelect.value=""; proceedToScanBtn.classList.add('hidden'); loggedInAdmin=null; adminFaceMatcher=null; clearInterval(adminScanInterval); }

    // --- After login
    async function onLoginSuccess(){
      clearInterval(adminScanInterval); stopCamera();
      const session={ name:loggedInAdmin.name, imageUrl:loggedInAdmin.imageUrl, role:loggedInAdmin.role };
      saveSession(session);

      // Profile + sidebar
      adminProfileImgHeader.crossOrigin='anonymous'; adminProfileImgSidebar.crossOrigin='anonymous';
      adminProfileImgHeader.src=session.imageUrl; adminProfileImgSidebar.src=session.imageUrl;
      adminNameSidebar.textContent=session.name;
      adminRoleBadge.textContent=session.role.toUpperCase();
      adminRoleBadge.className = 'text-xs px-2 py-0.5 rounded ' + (session.role==='superadmin'?'bg-orange-600':session.role==='admin'?'bg-indigo-600':session.role==='subadmin'?'bg-emerald-600':'bg-slate-600');
      adminProfileImgHeader.classList.remove('hidden'); adminProfileSidebar.classList.remove('hidden');

      // Profile page fill
      profilePhoto.src=session.imageUrl; profileName.textContent=session.name;
      profileRole.textContent=session.role.toUpperCase();
      profileRole.className='text-xs uppercase tracking-wider px-2 py-1 rounded '+(session.role==='superadmin'?'bg-orange-600':session.role==='admin'?'bg-indigo-600':session.role==='subadmin'?'bg-emerald-600':'bg-slate-600');
      profilePosition.value = loadPosition(session.name);

      renderPermissions(session.role);
      applyRoleLocks(session.role);

      // Add Admin Management nav if superadmin
      if (session.role === 'superadmin' && !document.getElementById('nav-admins')) {
        const li=document.createElement('li');
        li.innerHTML = `<a href="#" id="nav-admins" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white"><i class="fas fa-user-gear fa-fw"></i><span class="font-semibold">Manage Admins</span></a>`;
        sidebarLinks.insertBefore(li, sidebarLinks.lastElementChild); // before profile/footer
        document.getElementById('nav-admins').onclick = (e)=>{ e.preventDefault(); gotoPage(pageAdmins, document.getElementById('nav-admins')); loadAdminTable(); };
      }

      // Hide login, show app
      document.getElementById('login-screen').remove();
      document.getElementById('main-app-wrapper').classList.remove('hidden');

      // Load data
      await fetchStudents();
    }

    // --- Permissions ----
    function renderPermissions(role){
      const abilities = {
        superadmin:['Manage admins','Delete images','Capture students','View all data'],
        admin:['Delete images','Capture students','View all data'],
        subadmin:['Capture students','View all data'],
        viewer:['View data only']
      }[role] || [];
      permList.innerHTML=''; abilities.forEach(a=>permList.insertAdjacentHTML('beforeend', `<li class="px-3 py-2 bg-slate-700/60 rounded">${a}</li>`));
    }
    function applyRoleLocks(role){
      // viewer cannot scan/capture; subadmin cannot delete
      const navs = { scan:navScan, list:navList, records:navRecords };
      if(role==='viewer'){
        // disable Scan + selection
        navScan.classList.add('pointer-events-none','opacity-50');
        selectionArea.innerHTML = `<div class="p-4 text-center text-slate-400">Viewer mode: cannot capture.</div>`;
      }
      // Hide delete buttons later when rendering tables
    }

    // --- Logout buttons
    const doLogout = (e)=>{ e&&e.preventDefault(); clearSession(); location.reload(); };
    logoutBtn.onclick = doLogout; logoutBtnProfile.onclick = doLogout;
    document.getElementById('save-position').onclick = ()=>{ const s=loadSession(); if(!s) return; savePosition(s.name, profilePosition.value||''); showModal('success','Position saved.'); };

    // --- Students & Records (mostly same)
    async function fetchStudents(){ try{ const r=await fetch(`${SCRIPT_URL}?action=getStudents`); if(!r.ok) throw new Error(`Server error: ${r.status}`); const d=await r.json(); if(d.status==='error') throw new Error(d.message); studentsData=d.slice(1); allStudentsListData=studentsData; populateStudentList(); }catch(e){ showModal('error',`Could not fetch student data: ${e.message}`);} }
    function populateStudentList(filter=''){ const s=loadSession(); const role=s?.role||'viewer'; studentList.innerHTML=''; const f=(filter||'').toLowerCase(); const arr=studentsData.filter(x=>(x[0]||'').toString().toLowerCase().includes(f)||(x[1]||'').toLowerCase().includes(f)); if(!arr.length){ studentList.innerHTML=`<li class="text-center text-slate-400 p-4">No students found.</li>`; return; } arr.forEach(st=>{ const li=document.createElement('li'); li.className='p-3 rounded-lg cursor-pointer transition flex justify-between items-center'; const cnt=st[4]; if(cnt>0) li.classList.add('completed'); const ind=cnt>0?`<i class="fas fa-check-circle ml-2 text-green-400"></i>`:''; if(cnt>0 || role==='viewer'){ li.style.pointerEvents='none'; li.style.opacity=cnt>0?.7:.6; if(role==='viewer') li.title='Viewer cannot capture'; } else { li.onclick=()=>{ selectedStudent=st; showCameraModeSelection(); }; } li.innerHTML=`<span>${st[0]} - ${st[1]}</span>${ind}`; studentList.appendChild(li); }); }
    function showCameraModeSelection(){ showModal('choice','សូមជ្រើសរើសប្រតិបត្តិកាមេរ៉ា',{ 'ថតរូបស្វ័យប្រវត្តិ':{callback:()=>startCamera('user','auto'),className:"w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition"}, 'ថតរូបដោយខ្លួនឯង':{callback:()=>startCamera('user','manual'),className:"w-full bg-slate-600 text-white py-3 rounded-lg font-semibold hover:bg-slate-700 transition"} }); }

    // Records
    async function displaySavedRecords(){ recordsLoading.style.display='block'; recordsTable.classList.add('hidden'); try{ const r=await fetch(`${SCRIPT_URL}?action=getSavedData`); if(!r.ok) throw new Error(`Server error: ${r.status}`); const d=await r.json(); savedRecordsData=d.slice(1); populateClassFilter(savedRecordsData, recordsClassFilter); filterRecordsTable(); recordsLoading.style.display='none'; recordsTable.classList.remove('hidden'); }catch(e){ recordsLoading.innerHTML=`<p class="text-red-400">Error: ${e.message}</p>`; } }
    function populateClassFilter(records, el){ const classes=[...new Set(records.map(r=>r[3]).filter(Boolean))]; el.innerHTML='<option value="all">All Classes</option>'; classes.sort().forEach(c=>el.innerHTML+=`<option value="${c}">${c}</option>`); }
    function filterRecordsTable(){ const s=loadSession(); const role=s?.role||'viewer'; const cls=recordsClassFilter.value, q=recordsSearchInput.value.toLowerCase(); const tbody=recordsTable.querySelector('tbody'); tbody.innerHTML=''; const recs=savedRecordsData.filter(r=>{ const cOk=cls==='all'||r[3]===cls; const sOk=(r[1]||'').toLowerCase().includes(q)||(r[2]||'').toString().toLowerCase().includes(q); return cOk&&sOk;}); if(!recs.length){ tbody.innerHTML=`<tr><td colspan="7" class="text-center p-4 text-slate-400">No records found.</td></tr>`; return; } recs.forEach(r=>{ const serial=r[0], url=r[5]; const tr=document.createElement('tr'); tr.className='border-b border-slate-700'; const delBtn = (role==='admin'||role==='superadmin')?`<button class="text-red-400 hover:text-red-600 transition delete-btn"><i class="fas fa-trash-alt"></i></button>`:`<span class="text-slate-600">-</span>`; tr.innerHTML=`<td class="p-3">${serial}</td><td class="p-3 whitespace-nowrap">${r[1]}</td><td class="p-3">${r[2]}</td><td class="p-3">${r[3]}</td><td class="p-3">${r[4]}</td><td class="p-3"><a href="${url}" target="_blank" rel="noopener noreferrer" class="relative block w-16 h-16 group rounded-lg overflow-hidden"><img src="${url}" crossorigin="anonymous" class="w-full h-full object-cover" alt="Student photo"></a></td><td class="p-3 text-center">${delBtn}</td>`; if(role==='admin'||role==='superadmin'){ tr.querySelector('.delete-btn').onclick=()=>handleDelete(serial,url,role); } tbody.appendChild(tr); }); }
    async function handleDelete(serialNumber, imageUrl, requesterRole){ showModal('confirm','Delete this record?',{ Cancel:{className:"w-full bg-slate-600 text-white py-2 rounded-lg font-semibold hover:bg-slate-700",callback:null}, Delete:{className:"w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700",callback:async()=>{ showModal('loading','Deleting...'); try{ const res=await fetch(SCRIPT_URL,{ method:'POST', body:JSON.stringify({ action:'delete', serialNumber, imageUrl, requesterRole }), redirect:'follow' }); const j=await res.json(); if(j.status==='success'){ showModal('success','Deleted!',{OK:{callback:async()=>{ await displaySavedRecords(); await fetchStudents(); await displayStudentList(); }}}); } else throw new Error(j.message||'Delete failed.'); }catch(e){ showModal('error',e.message||'Delete failed.'); }}}}); }

    // List page
    function populateListClassFilterV2(){ const classes=[...new Set(allStudentsListData.map(s=>s[2]).filter(Boolean))]; listClassFilter.innerHTML='<option value="all">All Students</option><option value="with_photos">With Photos</option>'; classes.sort().forEach(c=>listClassFilter.innerHTML+=`<option value="${c}">${c}</option>`); }
    function filterStudentListTable(){ const sel=listClassFilter.value, q=listSearchInput.value.toLowerCase(); const tbody=listTable.querySelector('tbody'); tbody.innerHTML=''; const map=new Map(savedRecordsData.map(r=>[r[2], r[5]])); let arr = sel==='all'?allStudentsListData:sel==='with_photos'?allStudentsListData.filter(s=>s[4]>0):allStudentsListData.filter(s=>s[2]===sel); arr=arr.filter(s=>(s[0]||'').toString().toLowerCase().includes(q)||(s[1]||'').toLowerCase().includes(q)); const done=arr.filter(s=>s[4]>0).length; if(!arr.length){ tbody.innerHTML=`<tr><td colspan="4" class="text-center p-4 text-slate-400">No students found.</td></tr>`; } else { arr.forEach(s=>{ const has=s[4]>0; const url=has?map.get(String(s[0])):null; const cell=url?`<a href="${url}" target="_blank" rel="noopener noreferrer" class="relative block w-12 h-12 group rounded-lg overflow-hidden mx-auto"><img src="${url}" crossorigin="anonymous" class="w-full h-full object-cover" alt="Student photo"></a>`:`<span class="text-slate-500">-</span>`; const icon=has?`<i class="fas fa-check-circle text-green-400"></i>`:`<i class="fas fa-times-circle text-red-400"></i>`; tbody.insertAdjacentHTML('beforeend', `<tr class="border-b border-slate-700"><td class="p-3">${s[0]}</td><td class="p-3 whitespace-nowrap">${s[1]}</td><td class="p-3">${cell}</td><td class="p-3 text-center">${icon}</td></tr>`); }); } listTotalCount.textContent=arr.length; listCompletedCount.textContent=done; listPendingCount.textContent=arr.length-done; }
    async function displayStudentList(){ listLoading.style.display='block'; listTable.classList.add('hidden'); if(!savedRecordsData.length){ try{ const r=await fetch(`${SCRIPT_URL}?action=getSavedData`); const d=await r.json(); savedRecordsData=d.slice(1);}catch(e){console.warn(e);} } populateListClassFilterV2(); filterStudentListTable(); listLoading.style.display='none'; listTable.classList.remove('hidden'); }

    // Camera
    async function startCamera(facingMode='user',mode='auto'){ const s=loadSession(); if(s?.role==='viewer'){ showModal('error','Viewer cannot capture.'); return; } currentFacingMode=facingMode; currentCameraMode=mode; stableFrames=0; subtitle.textContent=`Scanning for: ${selectedStudent[1]}`; cameraSection.classList.remove('hidden'); selectionArea.classList.add('hidden'); switchCameraBtn.classList.remove('hidden'); backBtn.classList.remove('hidden'); uploadBtn.classList.add('hidden'); retakeBtn.classList.add('hidden'); photoPreview.classList.add('hidden'); videoWrapper.classList.remove('hidden'); faceStatus.classList.remove('hidden'); stopCamera(); try{ const stream=await navigator.mediaDevices.getUserMedia({ video:{facingMode,width:{ideal:640},height:{ideal:480}}, audio:false }); currentStream=stream; video.srcObject=stream; video.onloadedmetadata=()=>{ if(mode==='auto'){ manualCaptureBtn.classList.add('hidden'); detectFace(); } else { manualCaptureBtn.classList.remove('hidden'); faceStatus.textContent="ចុចប៊ូតុងកាមេរ៉ាដើម្បីថត"; faceStatus.classList.remove('text-green-400'); videoWrapper.classList.remove('ready'); } }; }catch{ showModal('error','Please allow camera access.'); resetToSelection(); } }
    async function detectFace(){ const opts=new faceapi.TinyFaceDetectorOptions({inputSize:224,scoreThreshold:.5}); clearInterval(faceApiInterval); faceApiInterval=setInterval(async()=>{ const res=await faceapi.detectSingleFace(video,opts); if(res&&res.score>0.7){ stableFrames++; faceStatus.textContent=`Excellent! (${stableFrames}/4)`; faceStatus.classList.add('text-green-400'); videoWrapper.classList.add('ready'); if(stableFrames>=4) captureFace(); } else { stableFrames=0; faceStatus.textContent="Please center your face"; faceStatus.classList.remove('text-green-400'); videoWrapper.classList.remove('ready'); } },400); }
    function captureFace(){ clearInterval(faceApiInterval); const ctx=captureCanvas.getContext('2d'); const size=512; captureCanvas.width=size; captureCanvas.height=size; if(currentFacingMode==='user'){ ctx.translate(size,0); ctx.scale(-1,1); } const v=video.videoWidth/video.videoHeight; let sx=0,sy=0,sw=video.videoWidth,sh=video.videoHeight; if(v>1){ sw=sh; sx=(video.videoWidth-sw)/2;} else { sh=sw; sy=(video.videoHeight-sh)/2;} ctx.drawImage(video,sx,sy,sw,sh,0,0,size,size); photoPreview.src=captureCanvas.toDataURL('image/jpeg',.9); stopCamera(); switchCameraBtn.classList.add('hidden'); videoWrapper.classList.add('hidden'); manualCaptureBtn.classList.add('hidden'); photoPreview.classList.remove('hidden'); uploadBtn.classList.remove('hidden'); retakeBtn.classList.remove('hidden'); faceStatus.classList.add('hidden'); subtitle.textContent="Confirm your photo"; }
    function stopCamera(){ if(currentStream) currentStream.getTracks().forEach(t=>t.stop()); clearInterval(faceApiInterval); clearInterval(adminScanInterval); }
    function resetToSelection(){ stopCamera(); cameraSection.classList.add('hidden'); switchCameraBtn.classList.add('hidden'); manualCaptureBtn.classList.add('hidden'); backBtn.classList.add('hidden'); photoPreview.classList.add('hidden'); uploadBtn.classList.add('hidden'); retakeBtn.classList.add('hidden'); videoWrapper.classList.remove('hidden'); selectionArea.classList.remove('hidden'); subtitle.textContent="Select your ID or Name"; selectedStudent=null; }
    manualCaptureBtn.onclick=captureFace;
    uploadBtn.onclick=async()=>{ if(isUploading) return; const s=loadSession(); if(!selectedStudent){ showModal('error','No student selected.'); return; } const imageData=captureCanvas.toDataURL('image/jpeg',.9).split(',')[1]; showModal('loading','Uploading...'); isUploading=true; try{ const res=await fetch(SCRIPT_URL,{ method:'POST', body:JSON.stringify({ id:selectedStudent[0], name:selectedStudent[1], class:selectedStudent[2], group:selectedStudent[3], imageData }), redirect:'follow' }); const j=await res.json(); if(j.status==='success'){ showModal('success','Image saved!',{OK:{callback:async()=>{ resetToSelection(); await fetchStudents(); }}}); } else throw new Error(j.message||'Upload failed.'); }catch(e){ showModal('error', e.message||'Upload failed.'); } finally{ isUploading=false; } };
    retakeBtn.onclick=()=>{ photoPreview.classList.add('hidden'); uploadBtn.classList.add('hidden'); retakeBtn.classList.add('hidden'); videoWrapper.classList.remove('hidden'); faceStatus.classList.remove('hidden'); stableFrames=0; startCamera(currentFacingMode,currentCameraMode); };

    // Storage links
    function populateStorageLinks(){ const c=document.getElementById('storage-links-container'); const links={'Sheets':{'Student List (DIList)':'https://docs.google.com/spreadsheets/d/1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc/edit','Saved Info & Admins (InfoUsers)':'https://docs.google.com/spreadsheets/d/1dleEg_Q5KV9IRGT4DpfHooZQ_p2bKLk-2yCGYootqPA/edit','Secondary List (បញ្ជឺឈ្មោះរួម)':'https://docs.google.com/spreadsheets/d/1_Kgl8UQXRsVATt_BOHYQjVWYKkRIBA12R-qnsBoSUzc/edit'},'Folders':{'Default Uploads':'https://drive.google.com/drive/folders/10RyejYi9_J0c7gxrL5wgmODy4VfJZ6SA','AD Class':'https://drive.google.com/drive/folders/140JXHUU9FIKB7VNEXUsv9rPJ4i8S_SMY'}}; c.innerHTML=''; for(const [cat,items] of Object.entries(links)){ let h=`<div class="mb-6"><h3 class="text-xl font-semibold text-indigo-300 mb-3">${cat}</h3><div class="space-y-2">`; for(const [t,u] of Object.entries(items)){ h+=`<a href="${u}" target="_blank" rel="noopener noreferrer" class="flex items-center justify-between p-4 bg-slate-700/50 rounded-lg hover:bg-slate-600/50 transition"><span class="font-medium">${t}</span><i class="fas fa-external-link-alt text-slate-400"></i></a>`;} h+=`</div></div>`; c.innerHTML+=h; } }

    // Admin Management (superadmin)
    async function loadAdminTable(){ // reload
      await fetchAdmins();
      adminsTbody.innerHTML='';
      adminData.forEach(a=>{
        const tr=document.createElement('tr'); tr.className='border-b border-slate-700';
        tr.innerHTML=`
          <td class="p-3">${a.name}</td>
          <td class="p-3"><a class="text-indigo-300 underline" href="${a.imageUrl}" target="_blank">Open</a></td>
          <td class="p-3">
            <select class="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm role-dd">
              <option ${a.role==='superadmin'?'selected':''}>superadmin</option>
              <option ${a.role==='admin'?'selected':''}>admin</option>
              <option ${a.role==='subadmin'?'selected':''}>subadmin</option>
              <option ${a.role==='viewer'?'selected':''}>viewer</option>
            </select>
          </td>
          <td class="p-3 text-center space-x-2">
            <button class="px-2 py-1 bg-emerald-600 rounded text-white save-btn">Save</button>
            <button class="px-2 py-1 bg-red-600 rounded text-white del-btn">Delete</button>
          </td>`;
        const roleDd = tr.querySelector('.role-dd');
        tr.querySelector('.save-btn').onclick = async()=>{
          const nameNew = prompt('Edit name:', a.name) || a.name;
          const imageNew = prompt('Edit image URL:', a.imageUrl) || a.imageUrl;
          await adminPost('admin.update', { originalName:a.name, name:nameNew, imageUrl:imageNew, role:roleDd.value });
          await loadAdminTable();
        };
        tr.querySelector('.del-btn').onclick = async()=>{
          if(!confirm('Delete this admin?')) return;
          await adminPost('admin.delete', { name:a.name });
          await loadAdminTable();
        };
        adminsTbody.appendChild(tr);
      });
    }
    addAdminBtn.onclick = async()=>{
      const name = prompt('Admin name:'); if(!name) return;
      const imageUrl = prompt('Image URL:'); if(!imageUrl) return;
      const role = prompt('Role (superadmin/admin/subadmin/viewer):','viewer')||'viewer';
      await adminPost('admin.create', { name, imageUrl, role });
      await loadAdminTable();
    };
    async function adminPost(action, body){
      const s=loadSession(); if(s?.role!=='superadmin'){ showModal('error','Superadmin only.'); return; }
      showModal('loading','Saving...');
      const res=await fetch(SCRIPT_URL,{ method:'POST', body:JSON.stringify({ action, requesterRole:s.role, ...body }) });
      const j=await res.json();
      if(j.status==='success'){ modal.classList.add('hidden'); }
      else { showModal('error', j.message||'Request failed'); }
    }

    // --- Navigation helpers
    const pages=[pageScan,pageList,pageRecords,pageStorage,pageProfile,pageAdmins];
    const navs=[navScan,navList,navRecords,navStorage,navProfile];
    function gotoPage(p,nav){ navs.forEach(n=>n&&n.classList.remove('active')); pages.forEach(pg=>pg.classList.add('hidden')); if(nav) nav.classList.add('active'); p.classList.remove('hidden'); stopCamera(); if(p===pageRecords) displaySavedRecords(); if(p===pageList) displayStudentList(); if(p===pageStorage) populateStorageLinks(); }
    navScan.onclick=(e)=>{e.preventDefault(); gotoPage(pageScan,navScan);};
    navList.onclick=(e)=>{e.preventDefault(); gotoPage(pageList,navList);};
    navRecords.onclick=(e)=>{e.preventDefault(); gotoPage(pageRecords,navRecords);};
    navStorage.onclick=(e)=>{e.preventDefault(); gotoPage(pageStorage,navStorage);};
    navProfile.onclick=(e)=>{e.preventDefault(); gotoPage(pageProfile,navProfile);};

    const closeSidebar=()=>{ sidebar.classList.remove('is-open'); sidebarBackdrop.classList.add('hidden'); };
    menuBtn.onclick=()=>{ sidebar.classList.toggle('is-open'); sidebarBackdrop.classList.toggle('hidden'); };
    sidebarBackdrop.onclick=()=>closeSidebar();

    recordsClassFilter.onchange=()=>filterRecordsTable();
    listClassFilter.onchange=()=>filterStudentListTable();
    recordsSearchInput.oninput=()=>filterRecordsTable();
    listSearchInput.oninput=()=>filterStudentListTable();
    studentSearchInput.oninput=()=>populateStudentList(studentSearchInput.value);
    backBtn.onclick=()=>resetToSelection();
    switchCameraBtn.onclick=()=>startCamera(currentFacingMode==='user'?'environment':'user', currentCameraMode);

    // --- Initial load with session restore
    window.onload = async ()=>{
      document.body.insertAdjacentHTML('afterbegin', `<div id="initial-loading" class="fixed inset-0 flex flex-col items-center justify-center bg-slate-900 z-50"><img src="di_logo.png" alt="Logo" class="w-24 h-24 rounded-full mb-4 shadow-lg"><p class="text-slate-300 text-lg">Loading Face Recognition Models...</p></div>`);
      await loadModels();
      try { await fetchAdmins(); } catch(e){ console.warn('fetchAdmins:', e); }
      const s = loadSession();
      if (s && s.name) {
        loggedInAdmin = { name:s.name, imageUrl:s.imageUrl, role:s.role };
        adminProfileImgHeader.crossOrigin='anonymous'; adminProfileImgSidebar.crossOrigin='anonymous';
        adminProfileImgHeader.src=s.imageUrl; adminProfileImgSidebar.src=s.imageUrl;
        adminNameSidebar.textContent=s.name; adminRoleBadge.textContent=s.role.toUpperCase(); adminRoleBadge.className='text-xs px-2 py-0.5 rounded '+(s.role==='superadmin'?'bg-orange-600':s.role==='admin'?'bg-indigo-600':s.role==='subadmin'?'bg-emerald-600':'bg-slate-600');
        adminProfileImgHeader.classList.remove('hidden'); adminProfileSidebar.classList.remove('hidden');
        profilePhoto.src=s.imageUrl; profileName.textContent=s.name; profileRole.textContent=s.role.toUpperCase(); profileRole.className='text-xs uppercase tracking-wider px-2 py-1 rounded '+(s.role==='superadmin'?'bg-orange-600':s.role==='admin'?'bg-indigo-600':s.role==='subadmin'?'bg-emerald-600':'bg-slate-600'); profilePosition.value=loadPosition(s.name);
        renderPermissions(s.role); applyRoleLocks(s.role);
        if (s.role==='superadmin' && !document.getElementById('nav-admins')) {
          const li=document.createElement('li'); li.innerHTML=`<a href="#" id="nav-admins" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white"><i class="fas fa-user-gear fa-fw"></i><span class="font-semibold">Manage Admins</span></a>`; sidebarLinks.insertBefore(li, sidebarLinks.lastElementChild); document.getElementById('nav-admins').onclick=(e)=>{e.preventDefault(); gotoPage(pageAdmins, document.getElementById('nav-admins')); loadAdminTable();};
        }
        document.getElementById('login-screen').remove();
        document.getElementById('main-app-wrapper').classList.remove('hidden');
        await fetchStudents();
      }
      document.getElementById('initial-loading').style.display='none';
    };
  </script>
</body>
</html>
